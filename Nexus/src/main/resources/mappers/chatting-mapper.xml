<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="chattingMapper">
 
 	<resultMap type="ChatRoom" id="chatRoomResultSet">
 		<result column="room_no" property="roomNo"/>
 		<result column="room_title" property="roomTitle"/>
 		<result column="number_participants" property="numberParticipants"/>
 		<result column="create_date" property="createDate"/>
 		<result column="status" property="status"/>
 		<result column="count" property="count"/>
 		<result column="user_no" property="userNo"/>
 		<result column="user_name" property="userName"/>
 	</resultMap>
 	
 	<resultMap type="ChatUser" id="chatUserResultSet">
 		<result column="room_no" property="roomNo"/>
 		<result column="user_no" property="userNo"/>
 		<result column="user_name" property="userName"/>
 		<result column="profile" property="profile"/>
 	</resultMap>
 	
 	<resultMap type="ChatMessage" id="chatMessageResultSet">
 		<result column="chatting_no" property="chattingNo"/>
 		<result column="chatting_content" property="chattingContent"/>
 		<result column="user_no" property="userNo"/>
 		<result column="user_name" property="userName"/>
 		<result column="create_date" property="createDate"/>
 		<result column="profile" property="profile"/>
 	</resultMap>
 	
 	<select id="selectRoom" resultMap="chatRoomResultSet">
 	select *
		from tb_chat_room r
		join tb_chat_user u using(room_no)
		where u.user_no = #{userNo}
   	 and r.status = 'Y'
 	</select>
 	
 	<select id="selectRoomUser" resultMap="chatUserResultSet">
 	select 
	    u.user_no,
	    room_no,
	    user_name,
	    profile
	from tb_chat_user u 
	join  tb_member m on(u.user_no = m.user_no)
	where room_no in (select room_no
	                            from tb_chat_room r
	                            join tb_chat_user u using(room_no)
	                            where u.user_no = #{userNo}
	                                and r.status = 'Y')
	        and u.user_no != #{userNo}
 	</select>
 
 	<select id="selectMessage" resultMap="chatMessageResultSet">
 		select chatting_no
	     , chatting_content
	     , user_no
	     , m.user_name
	     , create_date
	     , profile
	    from tb_chatting c
	    join tb_member m using(user_no) 
	  where room_no = #{rno}
	  order by chatting_no asc
 	</select>
 	<insert id="insertMessage">
 		insert 
 			into tb_chatting
 			values(seq_chatting.nextval, #{roomNo}, #{chattingContent}, null , null, #{userNo}, sysdate)
 	</insert>
 </mapper>